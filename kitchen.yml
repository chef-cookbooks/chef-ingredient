driver:
  name: vagrant
  customize:
    memory: 2048
    cpus: 2

provisioner:
  require_chef_omnibus: <%= ENV['CHEF_VERSION'] || true %>
  name: chef_infra
  data_bags_path: test/fixtures/data_bags
  deprecations_as_errors: true
  retry_on_exit_code:
    - 213
  max_retries: 1
  wait_for_retry: 1
  chef_license: accept-no-persist
  client_rb:
    exit_status: :enabled
    client_fork: false
    silence_deprecation_warnings:
    - chef-25

verifier:
  name: inspec

platforms:
  - name: amazonlinux-2
  - name: centos-7
  - name: centos-8
  - name: debian-10
  - name: fedora-latest
  - name: freebsd-12
  - name: opensuse-leap-15
  - name: ubuntu-18.04
  - name: ubuntu-20.04
  - name: macos-10.12
    driver:
      box: chef/macos-10.12 # private
  - name: windows-server-2016
    driver:
      box: stromweld/windows-2016
      customize:
        cpus: 4
  - name: windows-server-2019
    driver_config:
      box: stromweld/windows-2019
      customize:
        cpus: 4

default: &default
  attributes:
    chef-ingredient:
      mixlib-install:
        # Set to install mixlib-install from source
        git_ref: <%= ENV['MIXLIB_INSTALL_GIT_REF'] %>

suites:
  - name: default
    <<: *default
    excludes: [ 'macos-10.12', 'windows-server-2016', 'windows-server-2019' ]
    run_list:
      <% if ENV['MIXLIB_INSTALL_GIT_REF'] %>
      - recipe[test::install_git]
      <% end %>
      - recipe[test]
      - recipe[test::repo]

  - name: local_package_install
    <<: *default
    excludes: [ 'macos-10.12', 'windows-server-2016', 'windows-server-2019'  ]
    run_list:
      - recipe[test]
      - recipe[test::local]

  - name: chef_workstation
    <<: *default
    includes: [ 'ubuntu-18.04', 'ubuntu-20.04', 'centos-7', 'centos-8', 'macos-10.12', 'windows-server-20126', 'windows-server-2019'  ]
    run_list:
      <% if ENV['MIXLIB_INSTALL_GIT_REF'] %>
      - recipe[test::install_git]
      <% end %>
      - recipe[test]
      - recipe[test::chef_workstation]
    verifier:
      inspec_tests:
        - test/integration/chef-workstation

  - name: inspec
    <<: *default
    includes: [ 'ubuntu-18.04', 'ubuntu-20.04', 'centos-7', 'centos-8', 'macos-10.12', 'windows-server-2016', 'windows-server-2019'  ]
    run_list:
      <% if ENV['MIXLIB_INSTALL_GIT_REF'] %>
      - recipe[test::install_git]
      <% end %>
      - recipe[test]
      - recipe[test::inspec]

  - name: chef_server
    includes: [ 'ubuntu-18.04', 'ubuntu-20.04', 'centos-7', 'centos-8' ]
    run_list:
      - recipe[test]
      - recipe[test::chef_server]

  - name: chef_automatev2
    driver:
      customize:
        memory: 2560
    includes: [ 'ubuntu-18.04', 'ubuntu-20.04', 'centos-7', 'centos-8' ]
    run_list:
      - recipe[test::automatev2]
    verifier:
      inspec_tests:
        - test/integration/chef_automatev2
